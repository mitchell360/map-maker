# Historical Map Visualization Tool

## Overview
This project is an interactive map visualization tool built with Leaflet.js, designed to display historical locations with labeled markers, optional walking paths, estimated ancient travel times, and toggleable country and Roman road overlays. It is fully customizable via URL query parameters. The tool aims to provide an accessible and interactive way to explore historical journeys and locations, with a focus on ease of deployment and LLM-friendly documentation.

## User Preferences
- **CRITICAL:** Whenever adding or updating features, ALWAYS update the LLM instructions in `llm.md`.
- `llm.md` is a single Markdown file following web standards for LLM instruction documentation.
- This static file works with GitHub Pages and must always reflect the latest functionality.
- Markdown format is both LLM-friendly and human-readable when rendered on GitHub.

## System Architecture
The tool uses a hybrid architecture with a static frontend and a Flask backend for a screenshot API (primarily for Replit development). The frontend `index.html` file integrates Leaflet.js via CDN and handles all map rendering, geocoding, and graph-based routing logic. `llm.md` serves as the comprehensive, web-standard documentation for LLM instructions.

**UI/UX Decisions:**
- **Two Location Types:** Chronological (blue markers, connected by paths) and Reference (red markers, standalone).
- **Responsive Drawer Interface:** Markers open a detailed information drawer, which acts as a bottom sheet on mobile (with swipe gestures and pull handle) and a centered modal on desktop.
- **Permanent Labels:** Location names are displayed directly above markers (blue for chronological, red for reference).
- **Travel Line and Time Overlay:** Displays color-coded travel paths (purple gradient), numbered circular badges along paths, and a travel time information box.
- **Route Type Selector:** "Land Only" uses only Roman Roads, "Use Water" uses both Roman Roads AND itiner-e Sea Lanes for optimal mixed routing.
- **Transport Mode Selector:** 4 historical land travel speed options: Walking (4 km/h), Ox cart (2 km/h), Pack animal (4.5 km/h), Horse courier (6 km/h).
- **Custom Collapsible Layer Control Panel:** Replaces default Leaflet control with organized categories:
  - **Base Map:** Ancient Terrain (DARE Background + Hillshade), Ancient Full (DARE with roads), Modern Clean (CartoDB), Modern Detailed (OSM)
  - **Your Journey:** Route & Travel Time toggle
  - **Roman Infrastructure:** Roman Roads, Sea Lanes, Bridges, Aqueducts
  - **Settlements:** Famous Cities (50, default on), Major Cities (1.5k), All Cities (16k+), Fortifications
  - **Political:** Roman Provinces (with period selector: 60 BC, 117 AD, 200 AD), Modern Borders
  - **Water Features:** Rivers, Lakes, Sea Names, Sailing Routes
- **Three-Tier City System:** Famous Cities shows 50 curated major ancient cities (Rome, Athens, Alexandria, Jerusalem, Carthage, etc.) with Latin name labels by default. Click markers to see Latin, modern, and Greek names in popup.
- **Lazy Loading Overlays:** Ancient world data layers load on-demand when toggled to minimize initial load time.
- **Map Title:** Optional `title` URL parameter displays a centered title above the map.
- **Loading Progress Overlay:** Shows real-time status during map initialization, geocoding, and route calculation.

**Technical Implementations:**
- **itiner-e Graph-Based Routing:** Client-side Dijkstra shortest path on a preprocessed routing graph (11,031 nodes, 16,351 edges) built from the itiner-e Roman Roads dataset. Replaces external OSRM API calls.
- **Routing Graph Structure:** `itinere_graph.json` contains nodes, edges with type classification (land/sea/river), and a 0.25Â° spatial index for fast nearest-node lookup. Generated by `preprocess_graph.py`.
- **Edge Type Filtering:** "Land Only" mode filters to land+river edges only; "Use Water" mode includes all edges (land+sea+river+port) for optimal mixed routing.
- **Synthetic Port Connectors:** The preprocessing script creates 188 "port" edges connecting sea lane endpoints to nearby land road nodes (within 20km). This bridges the otherwise-disconnected sea and land networks, enabling mixed land/water routing.
- **Accurate Travel Time Calculation:** Uses actual edge-type breakdown from routing to calculate land vs. sea distances. Sailing speed: 4 knots (7.4 km/h), land transport speeds configurable.
- **URL-Driven Customization:** All features controllable via query parameters with `chronoLocationsAndLabels` and `referenceLocationsAndLabels` using `Location~Label|Location~Label` format.
- **Fast Local Geocoding:** A `coordinates.json` file contains 90+ pre-computed coordinates for common biblical/historical locations.
- **Static Deployment:** Designed for easy deployment to GitHub Pages.

**File Structure:**
- `index.html`: Main map application (static).
- `itinere_graph.json`: Preprocessed routing graph (11,031 nodes, 16,539 edges including 188 synthetic port connectors, ~18MB).
- `preprocess_graph.py`: Script to regenerate routing graph from roman_roads.ndjson.
- `llm.md`: LLM instruction documentation (static).
- `README.md`: GitHub-facing project documentation.
- `server.py`: Flask backend with screenshot API (Replit only).
- `coordinates.json`: Pre-computed coordinates for 90+ biblical/historical locations.
- `roman_roads.ndjson`: itiner-e Roman road network data (16,554 segments, 39MB).
- `country_borders.geojson`: Natural Earth country boundary data.
- `sailing_routes.json`: Mendeley ancient Mediterranean sailing routes (58 ports, for overlay display).
- `data/`: Ancient world overlay data files (lazy-loaded):
  - `famous_cities.geojson`: Curated 50 most important ancient cities (Rome, Athens, Alexandria, Jerusalem, etc.) with Latin, modern, and Greek names.
  - `places_low.geojson`: 1,523 major settlements from klokantech/roman-empire dataset.
  - `places_medium.geojson`: 16,000+ all settlements from klokantech/roman-empire dataset.
  - `provinces_60bc.geojson`: Roman province boundaries at 60 BC (74 provinces).
  - `provinces_117ad.geojson`: Roman province boundaries at 117 AD (112 provinces).
  - `provinces_200ad.geojson`: Roman province boundaries at 200 AD (112 provinces).
  - `bridges.geojson`: 124 Roman bridges extracted from DARE subsites data.
  - `rivers.geojson`: Ancient river network.
  - `lakes.geojson`: Ancient lakes and bodies of water.
  - `seas.geojson`: Major ancient sea name labels.
  - `aqueducts.geojson`: Roman aqueduct locations.
  - `fortifications.geojson`: Roman fortifications and military sites.

## External Dependencies
- **Mapping Library:** Leaflet.js (CDN-hosted)
- **Map Tile Sources:**
    - DARE (Digital Atlas of the Roman Empire) - dh.gu.se
    - CartoDB Positron (modern clean map)
    - OpenStreetMap (modern detailed map)
- **Geocoding API:** OpenStreetMap Nominatim API (fallback for unknown locations)
- **Routing:** Client-side graph-based routing using itiner-e network (no external API)
- **Country Boundary Data:** Natural Earth GeoJSON (local)
- **Roman Roads Data:** itiner-e dataset (local, preprocessed into routing graph)
- **Screenshot API (Replit only):** Playwright with system Chromium from Nix.
