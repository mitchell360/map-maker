<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>URL Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .leaflet-popup-content{font:22px/1.5 "Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:#1f2937;letter-spacing:0;margin:0;min-width:400px}
    .leaflet-popup-content-wrapper{border-radius:8px;padding:32px 36px;background:#ffffff;border:3px solid #1f2937;box-shadow:0 10px 40px rgba(0,0,0,.3);max-width:600px}
    .leaflet-popup-tip{background:#ffffff;border:3px solid #1f2937;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .popup-line{display:block;white-space:pre-wrap;margin-bottom:14px;line-height:1.5}
    .popup-line:first-child{font-weight:700;font-size:52px;color:#0369a1;letter-spacing:-.01em;margin-bottom:12px;line-height:1.1}
    .popup-line:nth-child(2),.popup-line:nth-child(3){color:#6b7280;font-size:20px;margin-bottom:8px}
    .popup-line:nth-child(n+4){color:#1f2937;font-size:22px;margin-top:20px;margin-bottom:10px}
    .popup-line:last-child{margin-bottom:0}
    .marker-label{background:#0369a1;color:#ffffff;border:none;box-shadow:0 2px 8px rgba(0,0,0,.3);font-weight:700;font-size:16px;padding:6px 12px;border-radius:4px}
    .marker-label::before{border-top-color:#0369a1!important}
    .distance-info{position:absolute;z-index:1000;bottom:12px;left:50%;transform:translateX(-50%);background:#fff;padding:10px 16px;border-radius:6px;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;box-shadow:0 2px 12px rgba(0,0,0,.2);border:2px solid #0369a1}
    .notice{position:absolute;z-index:1000;top:8px;left:8px;background:#fff;padding:6px 8px;border-radius:4px;font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;box-shadow:0 1px 4px rgba(0,0,0,.15)}
    .notice a{color:#0645AD;text-decoration:none}
    .notice code{background:#f5f5f5;padding:1px 3px;border-radius:3px}
  </style>
</head>
<body>
<div id="map"></div>
<div class="notice">
  Use query params. Example<br>
  <code>?points=Rome,Italy|Ephesus,Turkey&amp;labels=Rome%0A62 AD...&amp;path=false&amp;travelTime=false</code>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
function qs(name){const u=new URL(location.href);return u.searchParams.get(name);}
async function geocode(q){
  const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
  const r=await fetch(url,{headers:{'Accept-Language':'en','User-Agent':'URL-Map/1.0'}});
  if(!r.ok)return null;
  const j=await r.json();
  if(j&&j.length)return{lat:parseFloat(j[0].lat),lon:parseFloat(j[0].lon),display:j[0].display_name};
  return null;
}
async function getWalkingRoute(start,end){
  const coords=`${start.lon},${start.lat};${end.lon},${end.lat}`;
  const url=`https://routing.openstreetmap.de/routed-foot/route/v1/foot/${coords}?overview=full&geometries=geojson`;
  try{
    const r=await fetch(url);
    const data=await r.json();
    if(data.code==='Ok'&&data.routes&&data.routes.length>0){
      return{
        distance:data.routes[0].distance,
        duration:data.routes[0].duration,
        geometry:data.routes[0].geometry
      };
    }
  }catch(e){console.error('Route error:',e);}
  return null;
}
(async function(){
  const map=L.map('map',{zoomControl:true}).setView([20,0],2);
  const voyager=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap © CartoDB'}).addTo(map);
  const positron=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap © CartoDB'});
  const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'});
  const baseLayers={'Borders':voyager,'Clean':positron,'Detailed':osm};
  L.control.layers(baseLayers,null,{collapsed:true}).addTo(map);

  const defaultPoints='Rome,Italy|Ephesus,Turkey';
  const defaultLabels='Rome%0A62 AD: Rome, Capitol of the Roman Empire%0A2025 AD: Rome, Italy%0A%0APaul was held under house arrest in Rome from approximately AD 60 to 62|Ephesus%0A52-54 AD: Ephesus, Asia Minor%0A2025 AD: Selçuk, Turkey%0A%0APaul ministered in Ephesus for approximately three years during his third missionary journey';
  
  const points=(qs('points')||defaultPoints).split('|').filter(Boolean);
  const labels=(qs('labels')||defaultLabels).split('|');
  const toOpen=qs('open')||'all';
  const showTravelTime=qs('travelTime')!=='false';
  const showPath=qs('path')!=='false';

  const markers=[];
  const coords=[];
  for(let i=0;i<points.length;i++){
    const q=points[i].trim();
    if(!q)continue;
    let coord=null;
    const m=q.match(/^(.*)@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)$/);
    if(m){coord={lat:parseFloat(m[2]),lon:parseFloat(m[3])};}
    else{coord=await geocode(q);}
    if(!coord)continue;
    coords.push({lat:coord.lat,lon:coord.lon});
    const labelEncoded=labels[i]||q;
    const label=labelEncoded.replace(/%0A/gi,'\n');
    const lines=label.split('\n');
    const locationName=lines[0]||q;
    const html=lines.map(l=>'<span class="popup-line">'+l+'</span>').join('');
    const mk=L.marker([coord.lat,coord.lon])
      .addTo(map)
      .bindPopup(html,{autoClose:true,closeOnClick:false})
      .bindTooltip(locationName,{permanent:true,direction:'top',className:'marker-label'});
    markers.push(mk);
  }
  
  // Draw walking paths between consecutive locations if enabled
  let totalDistance=0;
  if(showPath){
    for(let i=0;i<coords.length-1;i++){
      const route=await getWalkingRoute(coords[i],coords[i+1]);
      if(route&&route.geometry){
        const latlngs=route.geometry.coordinates.map(c=>[c[1],c[0]]);
        L.polyline(latlngs,{color:'#0369a1',weight:3,opacity:0.7}).addTo(map);
        totalDistance+=route.distance;
      }
    }
  }
  
  if(markers.length){
    const g=new L.featureGroup(markers);
    map.fitBounds(g.getBounds().pad(0.18));
    
    // Show estimated travel time if routes were drawn and enabled
    if(totalDistance>0&&showTravelTime){
      const distKm=totalDistance/1000;
      // Ancient travel: ~25 km/day on foot, boats ~100 km/day on favorable conditions
      // Assume mix: 60% walking, 40% by boat for Mediterranean routes
      const walkingDist=distKm*0.6;
      const boatDist=distKm*0.4;
      const walkingDays=walkingDist/25;
      const boatDays=boatDist/100;
      const totalDays=Math.ceil(walkingDays+boatDays);
      const weeks=Math.floor(totalDays/7);
      const days=totalDays%7;
      let timeStr='';
      if(weeks>0)timeStr+=`${weeks} week${weeks>1?'s':''} `;
      if(days>0||weeks===0)timeStr+=`${days} day${days!==1?'s':''}`;
      const infoDiv=document.createElement('div');
      infoDiv.className='distance-info';
      infoDiv.innerHTML=`<strong>Estimated Travel Time:</strong> ${timeStr.trim()} <span style="font-size:12px;color:#6b7280">(${distKm.toFixed(0)} km via walking & boat)</span>`;
      document.body.appendChild(infoDiv);
    }
  }else{map.setView([37.8,20],5);}
})();
</script>
</body>
</html>
