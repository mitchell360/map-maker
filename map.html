<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>URL Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .leaflet-popup-content{font:15px/1.55 "Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:#d6dfe8;letter-spacing:.01em;margin:0}
    .leaflet-popup-content-wrapper{border-radius:12px;padding:18px 22px;background:#07131f;border:2px solid #0f6ecb;box-shadow:0 18px 36px rgba(4,15,35,.55)}
    .leaflet-popup-tip{background:#07131f;border:2px solid #0f6ecb;box-shadow:0 12px 28px rgba(4,15,35,.45)}
    .popup-line{display:block;white-space:pre-wrap;margin-bottom:8px}
    .popup-line:first-child{font-weight:700;font-size:20px;color:#0f6ecb;letter-spacing:.015em;margin-bottom:12px}
    .popup-line:not(:first-child){color:#8fa4bb}
    .popup-line:last-child{margin-bottom:0}
    .notice{position:absolute;z-index:1000;top:8px;left:8px;background:#fff;padding:6px 8px;border-radius:4px;font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;box-shadow:0 1px 4px rgba(0,0,0,.15)}
    .notice a{color:#0645AD;text-decoration:none}
    .notice code{background:#f5f5f5;padding:1px 3px;border-radius:3px}
  </style>
</head>
<body>
<div id="map"></div>
<div class="notice">
  Use query params. Example<br>
  <code>?points=Rome,Italy|Ephesus,Turkey&amp;labels=Rome%0Amodern%20Rome%0APaul%20in%20prison|Ephesus%0Amodern%20Selcuk%0AAudience%20church&amp;open=all</code>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
function qs(name){const u=new URL(location.href);return u.searchParams.get(name);}
async function geocode(q){
  const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
  const r=await fetch(url,{headers:{'Accept-Language':'en','User-Agent':'URL-Map/1.0'}});
  if(!r.ok)return null;
  const j=await r.json();
  if(j&&j.length)return{lat:parseFloat(j[0].lat),lon:parseFloat(j[0].lon),display:j[0].display_name};
  return null;
}
(async function(){
  const map=L.map('map',{zoomControl:true}).setView([20,0],2);
  const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
  const tonerLite=L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png',{maxZoom:20,attribution:'Map tiles by Stamen Design'});
  const baseLayers={'OSM':osm,'Toner Lite':tonerLite};
  L.control.layers(baseLayers,null,{collapsed:true}).addTo(map);

  const points=(qs('points')||'').split('|').filter(Boolean);
  const labels=(qs('labels')||'').split('|');
  const toOpen=qs('open')||'all';

  const markers=[];
  for(let i=0;i<points.length;i++){
    const q=points[i].trim();
    if(!q)continue;
    let coord=null;
    const m=q.match(/^(.*)@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)$/);
    if(m){coord={lat:parseFloat(m[2]),lon:parseFloat(m[3])};}
    else{coord=await geocode(q);}
    if(!coord)continue;
    const labelEncoded=labels[i]||q;
    const label=labelEncoded.replace(/%0A/gi,'\n');
    const html=label.split('\n').map(l=>'<span class="popup-line">'+l+'</span>').join('');
    const mk=L.marker([coord.lat,coord.lon]).addTo(map).bindPopup(html,{autoClose:false,closeOnClick:false});
    markers.push(mk);
  }
  if(markers.length){
    const g=new L.featureGroup(markers);
    map.fitBounds(g.getBounds().pad(0.18));
    if(toOpen==='all'){markers.forEach(m=>m.openPopup());}
    else if(toOpen){const idx=parseInt(toOpen,10);if(!isNaN(idx)&&markers[idx])markers[idx].openPopup();}
  }else{map.setView([37.8,20],5);}
})();
</script>
</body>
</html>
