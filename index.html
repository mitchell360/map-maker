<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>URL Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    
    /* Content styling for drawer */
    .popup-line{display:block;white-space:pre-wrap;margin-bottom:14px;line-height:1.5}
    .popup-line:first-child{font-weight:700;font-size:32px;color:#0369a1;letter-spacing:-.01em;margin-bottom:12px;line-height:1.1}
    .popup-line:nth-child(2),.popup-line:nth-child(3){color:#6b7280;font-size:16px;margin-bottom:8px}
    .popup-line:nth-child(n+4){color:#1f2937;font-size:18px;margin-top:20px;margin-bottom:10px}
    .popup-line:last-child{margin-bottom:0}
    
    /* Unified drawer - works on all devices */
    .drawer-backdrop{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;display:none;opacity:0;transition:opacity 0.3s ease;pointer-events:none}
    .drawer-backdrop.active{display:block;opacity:1;pointer-events:auto}
    .drawer{position:fixed;background:#fff;box-shadow:0 -4px 20px rgba(0,0,0,0.3);z-index:2001;transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;pointer-events:none}
    .drawer.active{transform:translateY(0);pointer-events:auto}
    .drawer-handle{width:40px;height:4px;background:#cbd5e1;border-radius:2px;margin:12px auto 8px;cursor:grab;flex-shrink:0}
    .drawer-content{overflow-y:auto;padding:0 20px 20px;flex:1}
    
    /* Mobile: bottom drawer */
    @media (max-width: 768px) {
      .drawer{bottom:0;left:0;right:0;border-radius:20px 20px 0 0;max-height:70vh}
    }
    
    /* Desktop: centered modal */
    @media (min-width: 769px) {
      .drawer{top:50%;left:50%;right:auto;bottom:auto;transform:translate(-50%,-50%) scale(0.9);border-radius:12px;max-width:600px;width:90%;max-height:80vh;opacity:0;visibility:hidden}
      .drawer.active{transform:translate(-50%,-50%) scale(1);opacity:1;visibility:visible}
      .drawer-handle{display:none}
      .popup-line:first-child{font-size:42px}
      .popup-line:nth-child(2),.popup-line:nth-child(3){font-size:18px}
      .popup-line:nth-child(n+4){font-size:20px}
    }
    
    /* Travel time display - responsive */
    .distance-info{position:absolute;z-index:1000;background:#fff;padding:10px 16px;border-radius:6px;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;box-shadow:0 2px 12px rgba(0,0,0,.2);border:2px solid #0369a1}
    .distance-info-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .distance-info-toggle{background:none;border:none;color:#0369a1;font-size:18px;cursor:pointer;padding:0;line-height:1;display:none}
    .distance-info-details{margin-top:8px}
    
    /* Desktop positioning */
    @media (min-width: 769px) {
      .distance-info{bottom:12px;left:50%;transform:translateX(-50%);max-width:600px}
    }
    
    /* Mobile positioning and collapsible */
    @media (max-width: 768px) {
      .distance-info{bottom:12px;left:12px;right:12px;max-width:none}
      .distance-info-toggle{display:inline-block}
      .distance-info-details{display:none}
      .distance-info-details.expanded{display:block}
      .distance-info-details > div{font-size:12px;line-height:1.5}
    }
    
    /* Instructions link - responsive */
    /* Instructions button - always shows as ? in upper right on all devices */
    .instructions-link{position:absolute;top:60px;right:12px;z-index:400;background:#fff;border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,.2);border:2px solid #0369a1;padding:0;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
    .instructions-link a{color:#0369a1;text-decoration:none;font-weight:700;font-size:20px;display:flex;width:100%;height:100%;align-items:center;justify-content:center}
    .instructions-link a:hover{background:#f0f9ff;border-radius:50%}
    
    /* Tooltip styles */
    .leaflet-tooltip.marker-label{
      background:#0369a1!important;
      color:#ffffff!important;
      border:none!important;
      box-shadow:0 2px 8px rgba(0,0,0,.3)!important;
      font-weight:700!important;
      font-size:14px!important;
      padding:4px 8px!important;
      border-radius:4px!important;
    }
    .leaflet-tooltip.marker-label::before{
      border-top-color:#0369a1!important;
    }
    .leaflet-tooltip.marker-label-reference{
      background:#dc2626!important;
      color:#ffffff!important;
      border:none!important;
      box-shadow:0 2px 8px rgba(0,0,0,.3)!important;
      font-weight:700!important;
      font-size:14px!important;
      padding:4px 8px!important;
      border-radius:4px!important;
    }
    .leaflet-tooltip.marker-label-reference::before{
      border-top-color:#dc2626!important;
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Mobile drawer -->
<div class="drawer-backdrop" id="drawerBackdrop"></div>
<div class="drawer" id="drawer">
  <div class="drawer-handle" id="drawerHandle"></div>
  <div class="drawer-content" id="drawerContent"></div>
</div>

<!-- Instructions link - always shows as ? button -->
<div class="instructions-link">
  <a href="https://mitchell360.com/map-maker/llm-instructions.html" title="Instructions for using this Map Maker">?</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// Cache-busting: Auto-add version parameter to force fresh loads in Replit preview
(function(){
  const url=new URL(window.location.href);
  if(!url.searchParams.has('_cb')){
    url.searchParams.set('_cb',Date.now());
    window.location.replace(url.toString());
  }
})();

// Utility functions
function qs(name){const u=new URL(location.href);return u.searchParams.get(name);}

// Drawer functionality
const drawer=document.getElementById('drawer');
const drawerBackdrop=document.getElementById('drawerBackdrop');
const drawerContent=document.getElementById('drawerContent');
const drawerHandle=document.getElementById('drawerHandle');

let drawerStartY=0;
let drawerCurrentY=0;
let isDragging=false;

function openDrawer(html){
  drawerContent.innerHTML=html;
  drawer.classList.add('active');
  drawerBackdrop.classList.add('active');
}

function closeDrawer(){
  drawer.classList.remove('active');
  drawerBackdrop.classList.remove('active');
  drawer.style.transform='';
}

// Touch gestures for drawer
drawerHandle.addEventListener('touchstart',e=>{
  isDragging=true;
  drawerStartY=e.touches[0].clientY;
  drawer.style.transition='none';
});

drawerHandle.addEventListener('touchmove',e=>{
  if(!isDragging)return;
  drawerCurrentY=e.touches[0].clientY-drawerStartY;
  if(drawerCurrentY>0){
    drawer.style.transform=`translateY(${drawerCurrentY}px)`;
  }
});

drawerHandle.addEventListener('touchend',e=>{
  if(!isDragging)return;
  isDragging=false;
  drawer.style.transition='';
  if(drawerCurrentY>100){
    closeDrawer();
  }else{
    drawer.style.transform='translateY(0)';
  }
  drawerCurrentY=0;
});

// Click backdrop to close
drawerBackdrop.addEventListener('click',closeDrawer);

// Geocoding
async function geocode(q){
  const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
  const r=await fetch(url,{headers:{'Accept-Language':'en','User-Agent':'URL-Map/1.0'}});
  if(!r.ok)return null;
  const j=await r.json();
  if(j&&j.length)return{lat:parseFloat(j[0].lat),lon:parseFloat(j[0].lon),display:j[0].display_name};
  return null;
}

// Walking routes
async function getWalkingRoute(start,end){
  const coords=`${start.lon},${start.lat};${end.lon},${end.lat}`;
  const url=`https://routing.openstreetmap.de/routed-foot/route/v1/foot/${coords}?overview=full&geometries=geojson`;
  try{
    const r=await fetch(url);
    const data=await r.json();
    if(data.code==='Ok'&&data.routes&&data.routes.length>0){
      return{
        distance:data.routes[0].distance,
        duration:data.routes[0].duration,
        geometry:data.routes[0].geometry
      };
    }
  }catch(e){console.error('Route error:',e);}
  return null;
}

// Initialize map
(async function(){
  const map=L.map('map',{zoomControl:true}).setView([20,0],2);
  const dare=L.tileLayer('https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png',{minZoom:4,maxZoom:11,attribution:'© <a href="https://dh.gu.se/dare/">Digital Atlas of the Roman Empire</a>'}).addTo(map);
  const positron=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap © CartoDB'});
  const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'});
  const baseLayers={'Ancient World':dare,'Modern (Clean)':positron,'Modern (Detailed)':osm};
  
  // Custom marker icons
  const blueIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
  const redIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
  
  // Create overlay layers
  const countryBorders=L.layerGroup();
  const walkingPaths=L.layerGroup();
  const travelTimeLayer=L.layerGroup();
  
  // Add invisible placeholders so layers show in control
  walkingPaths.addLayer(L.circle([0,0],{radius:1,opacity:0}));
  travelTimeLayer.addLayer(L.circle([0,0],{radius:1,opacity:0}));
  
  // Load country borders
  fetch('https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_0_countries.geojson')
    .then(r=>r.json())
    .then(data=>{
      L.geoJSON(data,{
        style:{
          color:'#1f2937',
          weight:2.5,
          opacity:0.8,
          fillOpacity:0
        }
      }).addTo(countryBorders);
    })
    .catch(e=>console.error('Border load error:',e));
  
  // Overlays are OFF by default but available in layer control
  const overlays={
    'Country Borders':countryBorders,
    'Walking Paths':walkingPaths,
    'Travel Time':travelTimeLayer
  };
  L.control.layers(baseLayers,overlays,{collapsed:true}).addTo(map);

  // Default data using new combined format
  const defaultChronoData='Antioch,Turkey~Antioch%0A47-48 AD: Antioch, Syria%0A2025 AD: Antakya, Turkey%0A%0AAntioch served as the primary mission base for Paul\'s ministry to the Gentiles and was where believers were first called Christians|Philippi,Greece~Philippi%0A49-50 AD: Philippi, Macedonia%0A2025 AD: Filippoi, Greece%0A%0APhilippi was the first European city where Paul established a Christian congregation during his second missionary journey|Ephesus,Turkey~Ephesus%0A52-54 AD: Ephesus, Asia Minor%0A2025 AD: Selçuk, Turkey%0A%0APaul ministered in Ephesus for approximately three years during his third missionary journey|Rome,Italy~Rome%0A62 AD: Rome, Capitol of the Roman Empire%0A2025 AD: Rome, Italy%0A%0APaul was held under house arrest in Rome from approximately AD 60 to 62';
  const defaultRefData='Jerusalem,Israel~Jerusalem%0A33 AD: Jerusalem, Judea%0A2025 AD: Jerusalem, Israel%0A%0AThe Church\'s birthplace and site of Pentecost';
  
  // Parse function for new combined format (Location~Label pairs)
  function parseLocationsAndLabels(paramStr){
    const results={locations:[],labels:[]};
    if(!paramStr)return results;
    const entries=paramStr.split('|').filter(Boolean);
    for(const entry of entries){
      const parts=entry.split('~');
      const location=parts[0]?.trim()||'';
      let label=parts[1]?.trim()||'';
      // If label is missing, empty, or explicitly "TBD", use the TBD placeholder
      if(!label||label===''||label==='TBD'){
        label=`TBD%0ATBD: Location information not provided%0A2025 AD: Unknown%0A%0APlease provide complete location details.`;
      }
      results.locations.push(location);
      results.labels.push(label);
    }
    return results;
  }
  
  // Check for new format first, fall back to old format with warning
  let chronoPoints,chronoLabels,refPoints,refLabels;
  const newChronoParam=qs('chronoLocationsAndLabels');
  const newRefParam=qs('referenceLocationsAndLabels');
  const oldChronoParam=qs('chrono');
  const oldChronoLabelsParam=qs('chronoLabels');
  const oldRefParam=qs('reference');
  const oldRefLabelsParam=qs('referenceLabels');
  
  if(newChronoParam||newRefParam){
    // New format
    const chronoData=parseLocationsAndLabels(newChronoParam||defaultChronoData);
    chronoPoints=chronoData.locations;
    chronoLabels=chronoData.labels;
    const refData=parseLocationsAndLabels(newRefParam||defaultRefData);
    refPoints=refData.locations;
    refLabels=refData.labels;
  }else if(oldChronoParam||oldRefParam){
    // Old format - maintain backward compatibility but warn
    console.warn('⚠️ DEPRECATED: Using old parameter format (chrono/chronoLabels). Please migrate to new format (chronoLocationsAndLabels). See https://mitchell360.com/map-maker/llm-instructions.html');
    chronoPoints=(oldChronoParam||'').split('|').filter(Boolean);
    chronoLabels=(oldChronoLabelsParam||'').split('|');
    refPoints=(oldRefParam||'').split('|').filter(Boolean);
    refLabels=(oldRefLabelsParam||'').split('|');
  }else{
    // No params - use defaults in new format
    const chronoData=parseLocationsAndLabels(defaultChronoData);
    chronoPoints=chronoData.locations;
    chronoLabels=chronoData.labels;
    const refData=parseLocationsAndLabels(defaultRefData);
    refPoints=refData.locations;
    refLabels=refData.labels;
  }

  const allMarkers=[];
  const chronoCoords=[];
  const chronoNames=[];
  
  // Process chronological locations (blue markers)
  for(let i=0;i<chronoPoints.length;i++){
    const q=chronoPoints[i].trim();
    if(!q)continue;
    let coord=null;
    const m=q.match(/^(.*)@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)$/);
    if(m){coord={lat:parseFloat(m[2]),lon:parseFloat(m[3])};}
    else{coord=await geocode(q);}
    if(!coord)continue;
    chronoCoords.push({lat:coord.lat,lon:coord.lon});
    const labelEncoded=chronoLabels[i]||q;
    const label=labelEncoded.replace(/%0A/gi,'\n');
    const lines=label.split('\n');
    const locationName=lines[0]||q;
    chronoNames.push(locationName);
    const html=lines.map(l=>'<span class="popup-line">'+l+'</span>').join('');
    
    const mk=L.marker([coord.lat,coord.lon],{icon:blueIcon})
      .addTo(map)
      .bindTooltip(locationName,{permanent:true,direction:'top',className:'marker-label'})
      .on('click',()=>openDrawer(html));
    
    allMarkers.push(mk);
  }
  
  // Process reference locations (red markers)
  for(let i=0;i<refPoints.length;i++){
    const q=refPoints[i].trim();
    if(!q)continue;
    let coord=null;
    const m=q.match(/^(.*)@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)$/);
    if(m){coord={lat:parseFloat(m[2]),lon:parseFloat(m[3])};}
    else{coord=await geocode(q);}
    if(!coord)continue;
    const labelEncoded=refLabels[i]||q;
    const label=labelEncoded.replace(/%0A/gi,'\n');
    const lines=label.split('\n');
    const locationName=lines[0]||q;
    const html=lines.map(l=>'<span class="popup-line">'+l+'</span>').join('');
    
    const mk=L.marker([coord.lat,coord.lon],{icon:redIcon})
      .addTo(map)
      .bindTooltip(locationName,{permanent:true,direction:'top',className:'marker-label-reference'})
      .on('click',()=>openDrawer(html));
    
    allMarkers.push(mk);
  }
  
  // Draw walking paths between consecutive chronological locations only
  let totalDistance=0;
  const legDistances=[];
  for(let i=0;i<chronoCoords.length-1;i++){
    const route=await getWalkingRoute(chronoCoords[i],chronoCoords[i+1]);
    if(route&&route.geometry){
      const latlngs=route.geometry.coordinates.map(c=>[c[1],c[0]]);
      L.polyline(latlngs,{color:'#0369a1',weight:3,opacity:0.7}).addTo(walkingPaths);
      totalDistance+=route.distance;
      legDistances.push(route.distance);
    }else{
      legDistances.push(0);
    }
  }
  
  if(allMarkers.length){
    const g=new L.featureGroup(allMarkers);
    map.fitBounds(g.getBounds().pad(0.18));
    
    // Create travel time display
    if(totalDistance>0){
      const formatTime=(distanceMeters)=>{
        const distKm=distanceMeters/1000;
        const walkingDist=distKm*0.6;
        const boatDist=distKm*0.4;
        const walkingDays=walkingDist/25;
        const boatDays=boatDist/100;
        const totalDays=Math.ceil(walkingDays+boatDays);
        const weeks=Math.floor(totalDays/7);
        const days=totalDays%7;
        let timeStr='';
        if(weeks>0)timeStr+=`${weeks} week${weeks>1?'s':''} `;
        if(days>0||weeks===0)timeStr+=`${days} day${days!==1?'s':''}`;
        return {timeStr:timeStr.trim(),distKm:distKm.toFixed(0),totalDays};
      };
      
      // Build legs display
      let legsHtml='';
      for(let i=0;i<legDistances.length;i++){
        if(legDistances[i]>0){
          const legTime=formatTime(legDistances[i]);
          legsHtml+=`<div>${chronoNames[i]} → ${chronoNames[i+1]}: <span style="color:#6b7280;">${legTime.timeStr} (${legTime.distKm} km)</span></div>`;
        }
      }
      
      const totalTime=formatTime(totalDistance);
      
      // Create travel time display element (hidden by default)
      const travelTimeDiv=document.createElement('div');
      travelTimeDiv.className='distance-info';
      travelTimeDiv.style.display='none';
      travelTimeDiv.innerHTML=`
        <div class="distance-info-header">
          <div><strong>Estimated Travel Time:</strong> ${totalTime.timeStr} <span style="font-size:12px;color:#6b7280">(${totalTime.distKm} km)</span></div>
          <button class="distance-info-toggle" onclick="this.parentElement.nextElementSibling.classList.toggle('expanded');this.textContent=this.textContent==='▼'?'▲':'▼'">▼</button>
        </div>
        <div class="distance-info-details">${legsHtml}</div>
      `;
      document.body.appendChild(travelTimeDiv);
      
      // Show/hide travel time display based on layer toggle
      map.on('overlayadd',function(e){
        if(e.name==='Travel Time')travelTimeDiv.style.display='block';
      });
      map.on('overlayremove',function(e){
        if(e.name==='Travel Time')travelTimeDiv.style.display='none';
      });
    }
  }else{map.setView([37.8,20],5);}
})();
</script>
</body>
</html>
